<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大富翁 - 本地多人遊戲</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', 'Roboto', sans-serif;
            overflow: hidden; /* 防止動畫期間出現滾動條 */
        }
        .board {
            display: grid;
            grid-template-columns: 120px repeat(9, 80px) 120px;
            grid-template-rows: 120px repeat(9, 80px) 120px;
            gap: 2px;
            width: 1044px;
            height: 1044px;
            margin: 20px auto;
            background-color: #334155; /* 柔和的深藍灰色 */
            border: 4px solid #334155;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2), 0 6px 6px rgba(0,0,0,0.25);
        }
        .space {
            background-color: #d8e8d8; /* 柔和的復古綠色 */
            border: 1px solid #475569; /* 中度藍灰色 */
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            text-align: center;
            padding: 2px;
            color: #1e293b;
        }
        .corner { grid-column: span 1; grid-row: span 1; }
        .top-row { grid-column: span 1; }
        .bottom-row { grid-column: span 1; }
        .left-col { grid-row: span 1; }
        .right-col { grid-row: span 1; }

        /* 棋盤格位置定義 */
        .space[data-id='0'] { grid-column: 11 / 12; grid-row: 11 / 12; }
        .space[data-id='1'] { grid-column: 10 / 11; grid-row: 11 / 12; }
        .space[data-id='2'] { grid-column: 9 / 10; grid-row: 11 / 12; }
        .space[data-id='3'] { grid-column: 8 / 9; grid-row: 11 / 12; }
        .space[data-id='4'] { grid-column: 7 / 8; grid-row: 11 / 12; }
        .space[data-id='5'] { grid-column: 6 / 7; grid-row: 11 / 12; }
        .space[data-id='6'] { grid-column: 5 / 6; grid-row: 11 / 12; }
        .space[data-id='7'] { grid-column: 4 / 5; grid-row: 11 / 12; }
        .space[data-id='8'] { grid-column: 3 / 4; grid-row: 11 / 12; }
        .space[data-id='9'] { grid-column: 2 / 3; grid-row: 11 / 12; }
        .space[data-id='10'] { grid-column: 1 / 2; grid-row: 11 / 12; }
        .space[data-id='11'] { grid-column: 1 / 2; grid-row: 10 / 11; }
        .space[data-id='12'] { grid-column: 1 / 2; grid-row: 9 / 10; }
        .space[data-id='13'] { grid-column: 1 / 2; grid-row: 8 / 9; }
        .space[data-id='14'] { grid-column: 1 / 2; grid-row: 7 / 8; }
        .space[data-id='15'] { grid-column: 1 / 2; grid-row: 6 / 7; }
        .space[data-id='16'] { grid-column: 1 / 2; grid-row: 5 / 6; }
        .space[data-id='17'] { grid-column: 1 / 2; grid-row: 4 / 5; }
        .space[data-id='18'] { grid-column: 1 / 2; grid-row: 3 / 4; }
        .space[data-id='19'] { grid-column: 1 / 2; grid-row: 2 / 3; }
        .space[data-id='20'] { grid-column: 1 / 2; grid-row: 1 / 2; }
        .space[data-id='21'] { grid-column: 2 / 3; grid-row: 1 / 2; }
        .space[data-id='22'] { grid-column: 3 / 4; grid-row: 1 / 2; }
        .space[data-id='23'] { grid-column: 4 / 5; grid-row: 1 / 2; }
        .space[data-id='24'] { grid-column: 5 / 6; grid-row: 1 / 2; }
        .space[data-id='25'] { grid-column: 6 / 7; grid-row: 1 / 2; }
        .space[data-id='26'] { grid-column: 7 / 8; grid-row: 1 / 2; }
        .space[data-id='27'] { grid-column: 8 / 9; grid-row: 1 / 2; }
        .space[data-id='28'] { grid-column: 9 / 10; grid-row: 1 / 2; }
        .space[data-id='29'] { grid-column: 10 / 11; grid-row: 1 / 2; }
        .space[data-id='30'] { grid-column: 11 / 12; grid-row: 1 / 2; }
        .space[data-id='31'] { grid-column: 11 / 12; grid-row: 2 / 3; }
        .space[data-id='32'] { grid-column: 11 / 12; grid-row: 3 / 4; }
        .space[data-id='33'] { grid-column: 11 / 12; grid-row: 4 / 5; }
        .space[data-id='34'] { grid-column: 11 / 12; grid-row: 5 / 6; }
        .space[data-id='35'] { grid-column: 11 / 12; grid-row: 6 / 7; }
        .space[data-id='36'] { grid-column: 11 / 12; grid-row: 7 / 8; }
        .space[data-id='37'] { grid-column: 11 / 12; grid-row: 8 / 9; }
        .space[data-id='38'] { grid-column: 11 / 12; grid-row: 9 / 10; }
        .space[data-id='39'] { grid-column: 11 / 12; grid-row: 10 / 11; }

        .center-logo {
            grid-column: 2 / 11;
            grid-row: 2 / 11;
            background-color: #d8e8d8;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Montserrat', sans-serif;
            border: 2px solid #475569;
        }
        .center-logo-main {
            font-size: 6rem;
            color: #475569;
        }
        .center-logo-decks {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .deck {
            width: 120px;
            height: 80px;
            border: 2px dashed #475569;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #475569;
            transform: rotate(-10deg);
            transition: transform 0.2s ease;
        }
        .deck:hover {
            transform: rotate(-5deg) scale(1.05);
        }
        .deck.chance { background-color: #fdb813; }
        .deck.community-chest { background-color: #AADDDD; }


        .color-bar {
            width: 100%;
            height: 15px;
            flex-shrink: 0;
            position: relative;
        }
        .houses-container {
            position: absolute;
            top: 0;
            left: 2px;
            right: 2px;
            height: 100%;
            display: flex;
            gap: 1px;
            align-items: center;
        }
        .house {
            width: 12px;
            height: 12px;
            background-color: #22c55e;
            border: 1px solid #15803d;
        }
        .hotel {
            width: 20px;
            height: 12px;
            background-color: #ef4444;
            border: 1px solid #b91c1c;
        }

        .space-name {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            position: relative;
        }
        .property-nickname {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-style: italic;
            color: #e2e8f0;
            background: rgba(0,0,0,0.6);
            padding: 1px 4px;
            border-radius: 4px;
            white-space: nowrap;
        }
        .token {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
            transition: all 0.3s ease-in-out;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.7);
            z-index: 10;
        }
        .player-info {
            border: 2px solid;
            transition: all 0.3s ease;
        }
        .player-info.active {
            transform: scale(1.05);
            box-shadow: 0 0 20px;
        }
        .player-info.bankrupt {
            opacity: 0.5;
            background-color: #475569;
        }
        .cash-change {
            transition: color 0.2s, transform 0.2s;
        }
        .cash-change.positive {
            color: #4ade80; /* 明亮的綠色 */
            transform: scale(1.1);
        }
        .cash-change.negative {
            color: #f87171; /* 明亮的紅色 */
            transform: scale(1.1);
        }

        .property-owned-indicator {
            width: 100%;
            height: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        .mortgaged-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 5;
            backdrop-filter: grayscale(80%);
        }
        .dice {
            width: 60px;
            height: 60px;
            background-color: #f1f5f9;
            border: 2px solid #475569;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
            transition: transform 0.2s;
        }
        .dice-rolling {
            animation: roll 0.5s ease-out;
        }
        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }
        #modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .card-flip-container {
            perspective: 1000px;
        }
        .card-flipper {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card-flipper.flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
        }
        .card-front {
            border: 4px dashed #475569;
        }
        .card-back {
            transform: rotateY(180deg);
            border: 4px solid white;
            padding: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: black;
        }
    </style>
</head>
<body class="bg-slate-800 text-slate-200 flex flex-col lg:flex-row p-4 min-h-screen">

    <!-- 主選單畫面 -->
    <div id="main-menu" class="fixed inset-0 bg-slate-900 bg-opacity-90 flex justify-center items-center z-50">
        <div class="bg-slate-700 p-8 rounded-xl shadow-2xl w-full max-w-md text-center" data-step="1" data-intro="歡迎來到大富翁！從這裡開始您的遊戲。">
            <h1 class="text-5xl font-bold mb-8 text-amber-300">大富翁</h1>
            <div class="space-y-4">
                 <button id="new-game-btn" class="w-full bg-sky-700 hover:bg-sky-800 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300">新遊戲</button>
                 <button id="load-game-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">讀取遊戲</button>
                 <button id="options-btn" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300">選項</button>
                 <button id="tour-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300 mt-8">遊戲導覽</button>
            </div>
        </div>
    </div>

    <!-- 遊戲設定畫面 (從主選單觸發) -->
    <div id="setup-screen" class="hidden fixed inset-0 bg-slate-900 bg-opacity-90 flex justify-center items-center z-50">
        <div class="bg-slate-700 p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h2 class="text-2xl mb-4">設定新遊戲</h2>
            <div class="mb-6">
                <label for="player-count" class="block text-lg mb-2">玩家人數 (2-6)</label>
                <input type="number" id="player-count" min="2" max="6" value="2" class="w-32 p-2 rounded bg-slate-800 text-white text-center text-xl">
            </div>
            <button id="start-game-btn" class="bg-sky-700 hover:bg-sky-800 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300">開始遊戲</button>
        </div>
    </div>

    <!-- 主要遊戲區域 -->
    <div id="game-container" class="hidden flex-grow flex-col lg:flex-row">
        <!-- 左側面板: 玩家資訊 -->
        <div id="players-panel" class="w-full lg:w-1/4 lg:max-w-sm p-4 bg-slate-900 rounded-lg shadow-lg order-2 lg:order-1 mt-4 lg:mt-0 lg:mr-4" data-step="2" data-intro="這裡是玩家狀態區，您可以隨時查看每位玩家的現金和持有的地產。">
            <h2 class="text-3xl font-bold mb-4 text-center text-amber-400">玩家狀態</h2>
            <div id="player-info-container" class="space-y-4">
                <!-- 玩家資訊卡片將會在此生成 -->
            </div>
        </div>

        <!-- 中央面板: 棋盤與控制項 -->
        <div class="flex-grow flex flex-col items-center justify-center order-1 lg:order-2">
            <div class="board-container" style="transform: scale(0.8); transform-origin: top center;" data-step="3" data-intro="這就是我們的遊戲棋盤！您的目標是購買地產，讓對手破產，成為最有錢的玩家。">
                 <div class="board">
                    <!-- 將由 JS 填入內容 -->
                 </div>
            </div>
            <div id="controls-panel" class="mt-4 p-6 bg-slate-900 rounded-xl shadow-lg flex flex-col items-center w-full max-w-3xl" data-step="4" data-intro="遊戲的主要控制區在這裡。">
                <div id="log-message" class="h-12 text-lg text-amber-300 text-center mb-4" data-step="7" data-intro="遊戲中的所有事件都會顯示在這裡，記得隨時留意最新動態！">歡迎來到大富翁！</div>
                <div class="flex items-center space-x-4">
                    <div class="flex space-x-4">
                        <div id="dice1" class="dice">?</div>
                        <div id="dice2" class="dice">?</div>
                    </div>
                    <button id="roll-dice-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-8 rounded-lg text-2xl transition duration-300 shadow-md" data-step="5" data-intro="輪到您時，點擊『擲骰子』或按下空白鍵來決定您的步數。">擲骰子 (空白鍵)</button>
                     <button id="end-turn-btn" class="bg-amber-700 hover:bg-amber-800 text-white font-bold py-4 px-8 rounded-lg text-2xl transition duration-300 shadow-md hidden">結束回合</button>
                </div>
                 <div class="mt-4 flex space-x-4">
                    <button id="manage-properties-btn" class="bg-sky-700 hover:bg-sky-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300" data-step="6" data-intro="點擊這裡可以管理您的地產，像是蓋房子、賣房子或抵押地產。">管理資產</button>
                    <button id="taunt-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2">
                        <span>✨ AI 來句垃圾話</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 互動視窗 -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-40 hidden opacity-0">
        <div id="modal" class="bg-slate-800 rounded-xl shadow-2xl p-8 w-full max-w-lg transform scale-95 transition-transform duration-300">
            <h3 id="modal-title" class="text-3xl font-bold mb-4 text-center">視窗標題</h3>
            <div id="modal-body" class="text-lg mb-6 text-center">
                <p>視窗內容</p>
            </div>
            <div id="modal-actions" class="flex justify-center space-x-4">
                <!-- 視窗按鈕 -->
            </div>
        </div>
    </div>


    <script>
        // --- MODEL: 資料與遊戲邏輯 ---

        const boardData = [
            { id: 0, name: "起點", type: "go" },
            { id: 1, name: "地中海大道", type: "property", price: 60, rent: [2, 10, 30, 90, 160, 250], houseCost: 50, color: "#8B4513" },
            { id: 2, name: "公益福利", type: "community-chest" },
            { id: 3, name: "波羅的海大道", type: "property", price: 60, rent: [4, 20, 60, 180, 320, 450], houseCost: 50, color: "#8B4513" },
            { id: 4, name: "所得稅", type: "tax", price: 200 },
            { id: 5, name: "雷丁鐵路", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
            { id: 6, name: "東方大道", type: "property", price: 100, rent: [6, 30, 90, 270, 400, 550], houseCost: 50, color: "#AADDDD" },
            { id: 7, name: "機會", type: "chance" },
            { id: 8, name: "佛蒙特大道", type: "property", price: 100, rent: [6, 30, 90, 270, 400, 550], houseCost: 50, color: "#AADDDD" },
            { id: 9, name: "康乃狄克大道", type: "property", price: 120, rent: [8, 40, 100, 300, 450, 600], houseCost: 50, color: "#AADDDD" },
            { id: 10, name: "監獄 / 只是路過", type: "jail" },
            { id: 11, name: "聖查爾斯廣場", type: "property", price: 140, rent: [10, 50, 150, 450, 625, 750], houseCost: 100, color: "#DDA0DD" },
            { id: 12, name: "電力公司", type: "utility", price: 150 },
            { id: 13, name: "州際大道", type: "property", price: 140, rent: [10, 50, 150, 450, 625, 750], houseCost: 100, color: "#DDA0DD" },
            { id: 14, name: "維吉尼亞大道", type: "property", price: 160, rent: [12, 60, 180, 500, 700, 900], houseCost: 100, color: "#DDA0DD" },
            { id: 15, name: "賓州鐵路", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
            { id: 16, name: "聖詹姆斯廣場", type: "property", price: 180, rent: [14, 70, 200, 550, 750, 950], houseCost: 100, color: "#FDB813" },
            { id: 17, name: "公益福利", type: "community-chest" },
            { id: 18, name: "田納西大道", type: "property", price: 180, rent: [14, 70, 200, 550, 750, 950], houseCost: 100, color: "#FDB813" },
            { id: 19, name: "紐約大道", type: "property", price: 200, rent: [16, 80, 220, 600, 800, 1000], houseCost: 100, color: "#FDB813" },
            { id: 20, name: "免費停車場", type: "free-parking" },
            { id: 21, name: "肯塔基大道", type: "property", price: 220, rent: [18, 90, 250, 700, 875, 1050], houseCost: 150, color: "#D7263D" },
            { id: 22, name: "機會", type: "chance" },
            { id: 23, name: "印第安納大道", type: "property", price: 220, rent: [18, 90, 250, 700, 875, 1050], houseCost: 150, color: "#D7263D" },
            { id: 24, name: "伊利諾大道", type: "property", price: 240, rent: [20, 100, 300, 750, 925, 1100], houseCost: 150, color: "#D7263D" },
            { id: 25, name: "B. & O. 鐵路", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
            { id: 26, name: "大西洋大道", type: "property", price: 260, rent: [22, 110, 330, 800, 975, 1150], houseCost: 150, color: "#FEFE33" },
            { id: 27, name: "文特諾大道", type: "property", price: 260, rent: [22, 110, 330, 800, 975, 1150], houseCost: 150, color: "#FEFE33" },
            { id: 28, name: "自來水廠", type: "utility", price: 150 },
            { id: 29, name: "馬文花園", type: "property", price: 280, rent: [24, 120, 360, 850, 1025, 1200], houseCost: 150, color: "#FEFE33" },
            { id: 30, name: "進監獄", type: "go-to-jail" },
            { id: 31, name: "太平洋大道", type: "property", price: 300, rent: [26, 130, 390, 900, 1100, 1275], houseCost: 200, color: "#148649" },
            { id: 32, name: "北卡羅萊納大道", type: "property", price: 300, rent: [26, 130, 390, 900, 1100, 1275], houseCost: 200, color: "#148649" },
            { id: 33, name: "公益福利", type: "community-chest" },
            { id: 34, name: "賓州大道", type: "property", price: 320, rent: [28, 150, 450, 1000, 1200, 1400], houseCost: 200, color: "#148649" },
            { id: 35, name: "短線鐵路", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
            { id: 36, name: "機會", type: "chance" },
            { id: 37, name: "公園廣場", type: "property", price: 350, rent: [35, 175, 500, 1100, 1300, 1500], houseCost: 200, color: "#2A52BE" },
            { id: 38, name: "奢侈稅", type: "tax", price: 100 },
            { id: 39, name: "濱海大道", type: "property", price: 400, rent: [50, 200, 600, 1400, 1700, 2000], houseCost: 200, color: "#2A52BE" },
        ];
        
        const playerTokens = [
            { name: '戰艦', color: '#B0C4DE' },
            { name: '高帽', color: '#36454F' },
            { name: '賽車', color: '#FF4136' },
            { name: '頂針', color: '#CCCCCC' },
            { name: '蘇格蘭犬', color: '#5A4D41' },
            { name: '獨輪車', color: '#8B4513' }
        ];

        class Player {
            constructor(id, name, tokenColor, startingCash) {
                this.id = id;
                this.name = name;
                this.tokenColor = tokenColor;
                this.cash = startingCash;
                this.properties = new Set(); // 使用 Set 儲存地產 ID
                this.position = 0;
                this.inJail = false;
                this.jailTurns = 0;
                this.getOutOfJailFreeCards = 0;
                this.isBankrupt = false;
            }

            async move(steps) {
                const player = this;
                for (let i = 0; i < steps; i++) {
                    const oldPosition = player.position;
                    player.position = (player.position + 1) % 40;
                    ui.moveToken(player.id, player.position);
                    audio.playSound('move');
                    // 經過起點
                    if (!player.inJail && player.position < oldPosition) {
                        this.updateCash(200, `${player.name} 經過起點，領取 $200！`);
                    }
                    await new Promise(resolve => setTimeout(resolve, 100)); // 每步之間的延遲
                }
            }

            pay(amount, recipient = null) {
                if (this.cash >= amount) {
                    this.updateCash(-amount);
                    if (recipient) {
                        recipient.updateCash(amount);
                    } else {
                        // 支付給銀行
                        if (game.config.freeParkingJackpot) {
                            game.freeParkingPool += amount;
                            game.log(`$${amount} 已加入停車場獎金池！目前總額: $${game.freeParkingPool}`);
                        }
                    }
                    audio.playSound('pay');
                    return true;
                }
                
                // 資金不足，需要處理破產
                this.handleBankruptcy(amount, recipient);
                return false;
            }
            
            updateCash(amount, logMessage = '') {
                this.cash += amount;
                if (logMessage) game.log(logMessage);
                ui.flashCash(this.id, amount >= 0, Math.abs(amount));
                ui.updatePlayerInfo();
            }

            goToJail() {
                this.position = 10;
                this.inJail = true;
                this.jailTurns = 0;
                game.log(`${this.name} 入獄了！`);
                audio.playSound('jail');
                ui.moveToken(this.id, this.position);
            }

            handleBankruptcy(debt, creditor) {
                game.log(`${this.name} 資金不足，宣告破產！`);
                this.isBankrupt = true;
                
                // 轉交資產
                if (creditor) {
                    creditor.updateCash(this.cash);
                    this.properties.forEach(pId => {
                        creditor.properties.add(pId);
                        game.propertyOwners[pId].ownerId = creditor.id;
                        // 抵押的地產需要支付10%利息給新主人
                        if (game.propertyOwners[pId].mortgaged) {
                            game.log(`${creditor.name} 接收了抵押中的 ${boardData[pId].name}，可選擇支付 10% 利息解除抵押。`);
                        }
                    });
                     game.log(`${this.name} 的所有資產轉移給了 ${creditor.name}。`);
                } else {
                    // 破產給銀行，所有資產歸還銀行（拍賣）
                    this.properties.forEach(pId => {
                        delete game.propertyOwners[pId];
                    });
                    game.log(`${this.name} 的所有資產歸還給銀行。`);
                }

                this.cash = 0;
                this.properties.clear();
                
                ui.handlePlayerBankruptcy(this.id);
                game.checkWinCondition();
            }
        }

        class Game {
            constructor() {
                this.players = [];
                this.currentPlayerIndex = 0;
                // { propertyId: { ownerId: number, houses: number, mortgaged: boolean } }
                this.propertyOwners = {}; 
                this.propertyNicknames = {}; // { propertyId: "nickname" }
                this.dice = [0, 0];
                this.isTurnOver = false;
                this.chanceDeck = [];
                this.communityChestDeck = [];
                this.doublesCount = 0;
                this.freeParkingPool = 0;
                this.config = {
                    startingCash: 1500,
                    freeParkingJackpot: false,
                };
            }

            loadConfig() {
                const savedConfig = localStorage.getItem('monopolyConfig');
                if (savedConfig) {
                    this.config = JSON.parse(savedConfig);
                }
            }

            saveConfig() {
                localStorage.setItem('monopolyConfig', JSON.stringify(this.config));
            }

            setupGame(playerCount) {
                this.players = [];
                this.propertyOwners = {};
                this.propertyNicknames = {};
                this.freeParkingPool = 0;
                for (let i = 0; i < playerCount; i++) {
                    this.players.push(new Player(i, `玩家 ${i + 1}`, playerTokens[i].color, this.config.startingCash));
                }
                this.shuffleDecks();
                this.updateUI(true); // Full redraw
            }

            getCurrentPlayer() {
                return this.players[this.currentPlayerIndex];
            }

            rollDice() {
                this.dice[0] = Math.floor(Math.random() * 6) + 1;
                this.dice[1] = Math.floor(Math.random() * 6) + 1;
                ui.updateDice(this.dice[0], this.dice[1]);
                return { total: this.dice[0] + this.dice[1], isDoubles: this.dice[0] === this.dice[1] };
            }

            startTurn() {
                this.isTurnOver = false;
                this.doublesCount = 0;
                const player = this.getCurrentPlayer();

                if (player.isBankrupt) {
                    this.endTurn(true); // 直接跳過破產玩家的回合
                    return;
                }

                this.log(`${player.name} 的回合。`);
                ui.updatePlayerInfo();

                if (player.inJail) {
                    this.handleJailTurn(player);
                } else {
                    ui.enableRollDice();
                }
            }

            endTurn(force = false) {
                 if (!this.isTurnOver && !force) {
                    this.log("在結束回合前，您必須完成您的行動。");
                    return;
                }
                
                do {
                    this.currentPlayerIndex = (this.currentPlayerIndex + 1) % this.players.length;
                } while (this.players[this.currentPlayerIndex].isBankrupt)

                this.saveGame();
                this.startTurn();
            }

            async handlePlayerMove() {
                const player = this.getCurrentPlayer();
                ui.disableRollDice();
                await ui.animateDiceRoll();
                const { total, isDoubles } = this.rollDice();
                this.log(`${player.name} 擲出了 ${total} (${this.dice[0]} + ${this.dice[1]})。` + (isDoubles ? " 是對子！" : ""));
                
                if (isDoubles) {
                    this.doublesCount++;
                    if (this.doublesCount === 3) {
                        this.log("連續三次對子！直接入獄！");
                        player.goToJail();
                        this.isTurnOver = true;
                        ui.enableEndTurn();
                        return;
                    }
                } else {
                    this.doublesCount = 0;
                }
                
                await player.move(total);
                
                await this.handleLanding();

                if (isDoubles && !player.inJail) {
                    this.log("擲出對子，可以再擲一次！");
                    ui.enableRollDice();
                } else {
                    this.isTurnOver = true;
                    ui.enableEndTurn();
                }
            }
            
            async handleLanding() {
                const player = this.getCurrentPlayer();
                const space = boardData[player.position];
                this.log(`${player.name} 抵達 ${space.name}。`);

                switch(space.type) {
                    case 'property':
                    case 'railroad':
                    case 'utility':
                        this.handlePropertyLanding(player, space);
                        break;
                    case 'tax':
                        this.log(`${player.name} 必須支付 $${space.price} 的稅。`);
                        player.pay(space.price);
                        break;
                    case 'go-to-jail':
                        player.goToJail();
                        break;
                    case 'chance':
                        await this.drawCard('chance');
                        break;
                    case 'community-chest':
                        await this.drawCard('community-chest');
                        break;
                    case 'free-parking':
                        if (this.config.freeParkingJackpot && this.freeParkingPool > 0) {
                            player.updateCash(this.freeParkingPool, `${player.name} 贏得停車場獎金 $${this.freeParkingPool}！`);
                            this.freeParkingPool = 0;
                        }
                        break;
                    default:
                         break;
                }
                ui.updatePlayerInfo();
            }

            handlePropertyLanding(player, property) {
                const propState = this.propertyOwners[property.id];
                if (!propState) {
                    // 地產無人擁有
                    ui.showBuyPropertyDialog(player, property);
                } else if (propState.ownerId !== player.id) {
                    // 地產為其他玩家擁有
                    if (propState.mortgaged) {
                        this.log(`${property.name} 已被抵押，無需支付租金。`);
                    } else {
                        const owner = this.players[propState.ownerId];
                        const rent = this.calculateRent(property, owner);
                        this.log(`${player.name} 支付 $${rent} 租金給 ${owner.name}。`);
                        player.pay(rent, owner);
                    }
                } else {
                    // 玩家抵達自己的地產
                    this.log("您抵達了自己的地產。");
                }
            }

            buyProperty(player, property) {
                if (player.cash >= property.price) {
                    player.updateCash(-property.price);
                    player.properties.add(property.id);
                    this.propertyOwners[property.id] = { ownerId: player.id, houses: 0, mortgaged: false };
                    this.log(`${player.name} 以 $${property.price} 購買了 ${property.name}。`);
                    audio.playSound('buy');
                    ui.updatePropertyOwner(property.id, player.id);
                } else {
                    this.log(`${player.name} 無法負擔 ${property.name}。`);
                }
                ui.updatePlayerInfo();
            }
            
            calculateRent(property, owner) {
                const propState = this.propertyOwners[property.id];
                if (propState.mortgaged) return 0;

                if (property.type === 'property') {
                    const houseCount = propState.houses;
                    let rent = property.rent[houseCount];
                    // 如果擁有同色所有地產且沒有房子，租金加倍
                    if (houseCount === 0 && this.hasMonopoly(owner, property.color)) {
                        rent *= 2;
                    }
                    return rent;
                } else if (property.type === 'railroad') {
                    const numOwned = Array.from(owner.properties).filter(pId => boardData[pId].type === 'railroad' && !this.propertyOwners[pId].mortgaged).length;
                    return property.rent[numOwned - 1];
                } else if (property.type === 'utility') {
                    const numOwned = Array.from(owner.properties).filter(pId => boardData[pId].type === 'utility' && !this.propertyOwners[pId].mortgaged).length;
                    const rollTotal = this.dice[0] + this.dice[1];
                    return rollTotal * (numOwned === 1 ? 4 : 10);
                }
                return 0;
            }

            hasMonopoly(player, color) {
                const groupProperties = boardData.filter(p => p.color === color);
                return groupProperties.every(p => player.properties.has(p.id));
            }
            
            // ... Gemini 功能 ...
            async generateNickname(property, buttonElement) {
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '<div class="spinner"></div>';
                buttonElement.disabled = true;

                const prompt = `為大富翁地產「${property.name}」想一個簡短、有創意又有趣的暱稱。`;
                
                try {
                    const text = await this.callGeminiAPI(prompt);
                    const nickname = text.replace(/"/g, ''); // 清理引號
                    this.propertyNicknames[property.id] = nickname;
                    ui.updatePropertyNickname(property.id, nickname);
                    this.log(`${property.name} 的新暱稱: ${nickname}`);
                } catch (error) {
                    console.error("生成暱稱時發生錯誤:", error);
                    this.log("目前無法生成暱稱。");
                } finally {
                    buttonElement.innerHTML = originalText;
                    buttonElement.disabled = false;
                }
            }

            async generateTaunt(buttonElement) {
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '<div class="spinner"></div>';
                buttonElement.disabled = true;

                const player = this.getCurrentPlayer();
                const gameStateSummary = `
                    目前玩家: ${player.name} (現金: $${player.cash})。
                    所有玩家狀態: ${this.players.map(p => `${p.name} 有 $${p.cash} 及 p.properties.size 塊地產`).join('; ')}。
                    上一則訊息是: ${ui.logMessage.textContent}。
                `;
                const prompt = `你是一位說話風趣又帶點諷刺的大富翁玩家。根據以下的遊戲狀態，從目前玩家的角度，說一句簡短(1-2句話)又好笑的垃圾話。${gameStateSummary}`;

                try {
                    const taunt = await this.callGeminiAPI(prompt);
                    this.log(`[垃圾話] ${player.name}: ${taunt}`);
                } catch (error) {
                    console.error("生成垃圾話時發生錯誤:", error);
                    this.log("目前無法生成垃圾話。");
                } finally {
                    buttonElement.innerHTML = originalText;
                    buttonElement.disabled = false;
                }
            }
            
            async callGeminiAPI(prompt) {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // 保持空白，由環境處理
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API 請求失敗，狀態碼: ${response.status}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("來自 API 的回應結構無效");
                }
            }
            // --- Milestone 2, 3, 4 功能 ---

            shuffleDecks() {
                // 卡牌內容...
                const chanceCards = [
                    { text: "前進到「起點」。領取 $200。", action: 'move', position: 0 },
                    { text: "前進到「伊利諾大道」。", action: 'move', position: 24 },
                    { text: "前進到「聖查爾斯廣場」。", action: 'move', position: 11 },
                    { text: "銀行支付你 $50 紅利。", action: 'collect', amount: 50 },
                    { text: "獲得一張「出獄許可證」。", action: 'get_out_of_jail_free' },
                    { text: "後退三格。", action: 'move_relative', steps: -3 },
                    { text: "直接進監獄。不能經過起點，不能領取 $200。", action: 'go_to_jail' },
                    { text: "支付維修費：每棟房子 $25，每間旅館 $100。", action: 'repairs', house: 25, hotel: 100 },
                    { text: "支付 $15 罰款。", action: 'pay', amount: 15 },
                    { text: "前進到最近的鐵路。如果無人擁有，你可以購買。否則，支付雙倍租金給擁有者。", action: 'move_nearest', type: 'railroad' },
                    { text: "前進到「濱海大道」。", action: 'move', position: 39 },
                    { text: "你被選為董事長。支付每位玩家 $50。", action: 'pay_all', amount: 50 },
                    { text: "你的建築貸款到期。領取 $150。", action: 'collect', amount: 150 },
                ];
                const communityChestCards = [
                    { text: "前進到「起點」。領取 $200。", action: 'move', position: 0 },
                    { text: "銀行錯誤，對你有利。領取 $200。", action: 'collect', amount: 200 },
                    { text: "醫生費。支付 $50。", action: 'pay', amount: 50 },
                    { text: "股票銷售，你獲得 $50。", action: 'collect', amount: 50 },
                    { text: "獲得一張「出獄許可證」。", action: 'get_out_of_jail_free' },
                    { text: "直接進監獄。不能經過起點，不能領取 $200。", action: 'go_to_jail' },
                    { text: "節日基金到期。領取 $100。", action: 'collect', amount: 100 },
                    { text: "所得稅退稅。領取 $20。", action: 'collect', amount: 20 },
                    { text: "今天是你的生日。從每位玩家處領取 $10。", action: 'collect_all', amount: 10 },
                    { text: "人壽保險到期。領取 $100。", action: 'collect', amount: 100 },
                    { text: "支付醫院費用 $100。", action: 'pay', amount: 100 },
                    { text: "支付學費 $50。", action: 'pay', amount: 50 },
                    { text: "你因美容比賽第二名獲獎。領取 $10。", action: 'collect', amount: 10 },
                    { text: "你繼承了 $100。", action: 'collect', amount: 100 },
                ];

                this.chanceDeck = chanceCards.sort(() => Math.random() - 0.5);
                this.communityChestDeck = communityChestCards.sort(() => Math.random() - 0.5);
            }

            async drawCard(deckType) {
                const deck = deckType === 'chance' ? this.chanceDeck : this.communityChestDeck;
                const card = deck.shift();
                deck.push(card); // 將抽出的牌放回牌堆底部

                this.log(`抽到一張${deckType === 'chance' ? '機會' : '公益福利'}卡...`);
                audio.playSound('card');
                await ui.showCard(card, deckType);
                await this.handleCardEffect(card);
            }
            
            async handleCardEffect(card) {
                const player = this.getCurrentPlayer();
                
                switch (card.action) {
                    case 'move':
                        await player.move( (card.position - player.position + 40) % 40 );
                        await this.handleLanding();
                        break;
                    case 'collect':
                        player.updateCash(card.amount, `${player.name} 獲得 $${card.amount}。`);
                        break;
                    case 'pay':
                        player.pay(card.amount);
                        break;
                    case 'get_out_of_jail_free':
                        player.getOutOfJailFreeCards++;
                        this.log(`${player.name} 獲得一張出獄許可證。`);
                        break;
                    case 'go_to_jail':
                        player.goToJail();
                        break;
                    case 'move_relative':
                        await player.move(40 + card.steps); //加40確保是正數
                        await this.handleLanding();
                        break;
                    // ... 其他卡牌效果
                }
                ui.updatePlayerInfo();
            }

            handleJailTurn(player) {
                const actions = [];
                if (player.cash >= 50) {
                    actions.push({
                        label: '支付 $50 罰金',
                        className: 'bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded',
                        callback: () => {
                            player.pay(50);
                            player.inJail = false;
                            this.log(`${player.name} 支付了 $50 罰金出獄。`);
                            ui.enableRollDice();
                        }
                    });
                }
                if (player.getOutOfJailFreeCards > 0) {
                     actions.push({
                        label: '使用出獄許可證',
                        className: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded',
                        callback: () => {
                            player.getOutOfJailFreeCards--;
                            player.inJail = false;
                            this.log(`${player.name} 使用了出獄許可證。`);
                            ui.enableRollDice();
                        }
                    });
                }
                actions.push({
                    label: '嘗試擲對子',
                    className: 'bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded',
                    callback: async () => {
                        await ui.animateDiceRoll();
                        const { total, isDoubles } = this.rollDice();
                        if (isDoubles) {
                            player.inJail = false;
                            this.log(`${player.name} 擲出對子，成功出獄！`);
                            await player.move(total);
                            await this.handleLanding();
                            this.isTurnOver = true;
                            ui.enableEndTurn();
                        } else {
                            player.jailTurns++;
                            this.log(`${player.name} 未能擲出對子。`);
                            if (player.jailTurns >= 3) {
                                this.log(`已在監獄待了三回合，必須支付 $50 罰金。`);
                                player.pay(50);
                                player.inJail = false;
                            }
                            this.isTurnOver = true;
                            ui.enableEndTurn();
                        }
                    }
                });
                
                ui.showModal(
                    `${player.name} 在監獄中`,
                    `選擇一個方式離開監獄。這是你在監獄的第 ${player.jailTurns + 1} 回合。`,
                    actions
                );
            }

            checkWinCondition() {
                const activePlayers = this.players.filter(p => !p.isBankrupt);
                if (activePlayers.length === 1) {
                    const winner = activePlayers[0];
                    this.log(`遊戲結束！勝利者是 ${winner.name}！`);
                    localStorage.removeItem('monopolySaveGame'); // 遊戲結束後清除存檔
                    ui.showModal(
                        '遊戲結束！',
                        `<p class="text-2xl">恭喜 <span class="font-bold" style="color:${winner.tokenColor};">${winner.name}</span> 成為最終的勝利者！</p>`,
                        [{
                            label: '重新開始',
                            className: 'bg-sky-700 hover:bg-sky-800 text-white font-bold py-3 px-8 rounded-lg text-xl',
                            callback: () => window.location.reload()
                        }]
                    );
                }
            }

            saveGame() {
                const gameState = {
                    players: this.players,
                    currentPlayerIndex: this.currentPlayerIndex,
                    propertyOwners: this.propertyOwners,
                    propertyNicknames: this.propertyNicknames,
                    chanceDeck: this.chanceDeck,
                    communityChestDeck: this.communityChestDeck,
                    freeParkingPool: this.freeParkingPool,
                    logMessage: ui.logMessage.textContent,
                };
                localStorage.setItem('monopolySaveGame', JSON.stringify(gameState));
                console.log("遊戲已儲存");
            }

            loadGame() {
                const savedStateJSON = localStorage.getItem('monopolySaveGame');
                if (!savedStateJSON) {
                    this.log("找不到存檔！");
                    return false;
                }
                const savedState = JSON.parse(savedStateJSON);
                
                // 重新實例化 Player 物件
                this.players = savedState.players.map(pData => {
                    const player = new Player(pData.id, pData.name, pData.tokenColor, pData.cash);
                    Object.assign(player, pData);
                    player.properties = new Set(Array.from(pData.properties)); // 確保是 Set
                    return player;
                });

                this.currentPlayerIndex = savedState.currentPlayerIndex;
                this.propertyOwners = savedState.propertyOwners;
                this.propertyNicknames = savedState.propertyNicknames;
                this.chanceDeck = savedState.chanceDeck;
                this.communityChestDeck = savedState.communityChestDeck;
                this.freeParkingPool = savedState.freeParkingPool || 0;
                
                this.log("遊戲讀取成功！" + (savedState.logMessage || ''));
                this.updateUI(true); // 完全重繪 UI
                return true;
            }

            log(message) {
                console.log(message);
                ui.updateLog(message);
            }

            updateUI(fullRedraw = false) {
                if (fullRedraw) {
                    ui.drawBoard();
                    ui.createPlayerInfoCards(this.players);
                    // 根據讀取的狀態更新所有視覺元素
                    this.players.forEach(p => {
                        ui.moveToken(p.id, p.position);
                        if(p.isBankrupt) ui.handlePlayerBankruptcy(p.id);
                    });
                    for (const propId in this.propertyOwners) {
                        const propState = this.propertyOwners[propId];
                        ui.updatePropertyOwner(propId, propState.ownerId);
                        ui.updateHouses(propId, propState.houses);
                        ui.updateMortgageVisual(propId, propState.mortgaged);
                    }
                     for (const propId in this.propertyNicknames) {
                        ui.updatePropertyNickname(propId, this.propertyNicknames[propId]);
                    }
                }
                ui.updatePlayerInfo();
            }
        }

        // --- VIEW: UI 操作 ---

        class UI {
            constructor() {
                // DOM 元素
                this.mainMenu = document.getElementById('main-menu');
                this.newGameBtn = document.getElementById('new-game-btn');
                this.loadGameBtn = document.getElementById('load-game-btn');
                this.optionsBtn = document.getElementById('options-btn');
                this.tourBtn = document.getElementById('tour-btn');
                
                this.setupScreen = document.getElementById('setup-screen');
                this.gameContainer = document.getElementById('game-container');
                this.boardElement = document.querySelector('.board');
                this.playerInfoContainer = document.getElementById('player-info-container');
                this.logMessage = document.getElementById('log-message');
                this.dice1 = document.getElementById('dice1');
                this.dice2 = document.getElementById('dice2');
                this.rollDiceBtn = document.getElementById('roll-dice-btn');
                this.endTurnBtn = document.getElementById('end-turn-btn');
                this.managePropertiesBtn = document.getElementById('manage-properties-btn');
                this.tauntBtn = document.getElementById('taunt-btn');
                this.modalBackdrop = document.getElementById('modal-backdrop');
                this.modal = document.getElementById('modal');
                this.modalTitle = document.getElementById('modal-title');
                this.modalBody = document.getElementById('modal-body');
                this.modalActions = document.getElementById('modal-actions');
            }

            initialize() {
                this.checkSaveGame();

                this.newGameBtn.addEventListener('click', () => {
                    this.mainMenu.classList.add('hidden');
                    this.setupScreen.classList.remove('hidden');
                });

                this.loadGameBtn.addEventListener('click', () => {
                    if (game.loadGame()) {
                        this.mainMenu.classList.add('hidden');
                        this.gameContainer.classList.remove('hidden');
                        this.gameContainer.classList.add('flex');
                        audio.start();
                        game.startTurn();
                    }
                });

                this.optionsBtn.addEventListener('click', () => this.showOptionsDialog());
                this.tourBtn.addEventListener('click', () => this.startTour());

                document.getElementById('start-game-btn').addEventListener('click', () => {
                    const playerCount = parseInt(document.getElementById('player-count').value);
                    this.setupScreen.classList.add('hidden');
                    this.gameContainer.classList.remove('hidden');
                    this.gameContainer.classList.add('flex');
                    audio.start();
                    game.setupGame(playerCount);
                    game.startTurn();
                });

                this.rollDiceBtn.addEventListener('click', () => game.handlePlayerMove());
                this.endTurnBtn.addEventListener('click', () => game.endTurn());
                this.managePropertiesBtn.addEventListener('click', () => this.showManagePropertiesDialog());
                this.tauntBtn.addEventListener('click', (e) => game.generateTaunt(e.currentTarget));
                
                // 鍵盤快捷鍵
                window.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && !this.rollDiceBtn.disabled) {
                        e.preventDefault();
                        this.rollDiceBtn.click();
                    }
                });
            }

            startTour() {
                const intro = introJs();
                intro.setOptions({
                    steps: [
                        {
                            element: document.querySelector('#main-menu'),
                            intro: '歡迎來到大富翁！從這裡開始您的遊戲。您可以選擇「新遊戲」、「讀取遊戲」或調整「選項」。',
                            position: 'bottom'
                        },
                        {
                            element: document.querySelector('#players-panel'),
                            intro: '這裡是玩家狀態區，您可以隨時查看每位玩家的現金和持有的地產。',
                            position: 'right'
                        },
                        {
                            element: document.querySelector('.board-container'),
                            intro: '這就是我們的遊戲棋盤！您的目標是購買地產，讓對手破產，成為最有錢的玩家。',
                            position: 'left'
                        },
                        {
                            element: document.querySelector('#controls-panel'),
                            intro: '遊戲的主要控制區在這裡。',
                            position: 'top'
                        },
                        {
                            element: document.querySelector('#roll-dice-btn'),
                            intro: '輪到您時，點擊『擲骰子』或按下空白鍵來決定您的步數。',
                            position: 'top'
                        },
                        {
                            element: document.querySelector('#manage-properties-btn'),
                            intro: '點擊這裡可以管理您的地產，像是蓋房子、賣房子或抵押地產。',
                            position: 'top'
                        },
                        {
                            element: document.querySelector('#log-message'),
                            intro: '遊戲中的所有事件都會顯示在這裡，記得隨時留意最新動態！',
                            position: 'top'
                        }
                    ],
                    nextLabel: '下一步 &rarr;',
                    prevLabel: '&larr; 上一步',
                    doneLabel: '完成',
                    tooltipClass: 'custom-tooltip-class',
                    highlightClass: 'custom-highlight-class'
                });

                // 為了讓導覽正常運作，我們需要暫時進入遊戲畫面
                this.mainMenu.classList.add('hidden');
                this.gameContainer.classList.remove('hidden');
                this.gameContainer.classList.add('flex');
                if (game.players.length === 0) {
                     game.setupGame(2); // 建立一個暫時的遊戲狀態以供導覽
                }

                intro.oncomplete(() => {
                    // 如果是從主選單開始導覽，結束後返回主選單
                    if (game.players[0].cash === game.config.startingCash && game.players[0].position === 0) {
                         this.mainMenu.classList.remove('hidden');
                         this.gameContainer.classList.add('hidden');
                    }
                });
                 intro.onexit(() => {
                     if (game.players[0].cash === game.config.startingCash && game.players[0].position === 0) {
                         this.mainMenu.classList.remove('hidden');
                         this.gameContainer.classList.add('hidden');
                    }
                });

                intro.start();
            }

            checkSaveGame() {
                if (localStorage.getItem('monopolySaveGame')) {
                    this.loadGameBtn.disabled = false;
                } else {
                    this.loadGameBtn.disabled = true;
                }
            }

            drawBoard() {
                this.boardElement.innerHTML = '';
                boardData.forEach(space => {
                    const spaceEl = document.createElement('div');
                    spaceEl.className = 'space';
                    spaceEl.dataset.id = space.id;
                    
                    let content = `<div class="space-name">${space.name}</div>`;
                    if (space.type === 'property' || space.type === 'railroad' || space.type === 'utility') {
                        content = `<div class="color-bar" style="background-color: ${space.color || '#ccc'};"><div class="houses-container"></div></div>` + content;
                        content += `<div class="price">$${space.price}</div>`;
                    }
                    if (space.type === 'tax') {
                        content += `<div class="price">支付 $${space.price}</div>`;
                    }
                    if (space.type === 'go' || space.type === 'jail' || space.type === 'free-parking' || space.type === 'go-to-jail') {
                        spaceEl.classList.add('corner');
                    }
                    
                    spaceEl.innerHTML = content;
                    this.boardElement.appendChild(spaceEl);
                });
                
                const centerLogo = document.createElement('div');
                centerLogo.className = 'center-logo';
                centerLogo.innerHTML = `
                    <div class="center-logo-main">MONOPOLY</div>
                    <div class="center-logo-decks">
                        <div class="deck chance">機會</div>
                        <div class="deck community-chest">公益福利</div>
                    </div>
                `;
                this.boardElement.appendChild(centerLogo);
            }
            
            createPlayerInfoCards(players) {
                this.playerInfoContainer.innerHTML = '';
                players.forEach(player => {
                    const card = document.createElement('div');
                    card.id = `player-info-${player.id}`;
                    card.className = 'player-info p-4 rounded-lg bg-slate-800';
                    card.style.borderColor = player.tokenColor;
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xl font-bold">${player.name}</h3>
                            <div class="w-6 h-6 rounded-full" style="background-color: ${player.tokenColor};"></div>
                        </div>
                        <p class="text-2xl font-semibold text-lime-400">$<span class="cash">${player.cash}</span></p>
                        <div class="mt-2">
                            <h4 class="font-semibold text-slate-300">持有地產:</h4>
                            <div class="properties-list text-sm space-y-1 mt-1 text-slate-400">無</div>
                        </div>
                    `;
                    this.playerInfoContainer.appendChild(card);
                    
                    // 在棋盤上創建棋子
                    const tokenEl = document.createElement('div');
                    tokenEl.id = `token-${player.id}`;
                    tokenEl.className = 'token';
                    tokenEl.style.backgroundColor = player.tokenColor;
                    
                    document.querySelector(`.space[data-id='0']`).appendChild(tokenEl);
                    this.moveToken(player.id, 0);
                });
            }

            updatePlayerInfo() {
                game.players.forEach(player => {
                    const card = document.getElementById(`player-info-${player.id}`);
                    if (!card) return;
                    
                    card.querySelector('.cash').textContent = player.cash;
                    
                    const propsList = card.querySelector('.properties-list');
                    if (player.properties.size > 0) {
                        let propsHtml = '';
                        // Group properties by color
                        const groupedProps = {};
                        player.properties.forEach(pId => {
                            const pData = boardData[pId];
                            const color = pData.color || 'utility';
                            if (!groupedProps[color]) groupedProps[color] = [];
                            groupedProps[color].push(pData);
                        });

                        for (const color in groupedProps) {
                            const props = groupedProps[color];
                            const propState = game.propertyOwners[props[0].id];
                            const houseText = propState.houses === 5 ? ' (旅館)' : propState.houses > 0 ? ` (${propState.houses}房)` : '';
                            const mortgageText = propState.mortgaged ? ' (已抵押)' : '';
                            propsHtml += `
                                <div class="flex items-center">
                                    <div class="w-3 h-3 mr-2 rounded-sm flex-shrink-0" style="background-color:${props[0].color || '#ccc'}; border: 1px solid #94a3b8;"></div>
                                    <span>${props.map(p => p.name).join(', ')}${houseText}${mortgageText}</span>
                                </div>`;
                        }
                        propsList.innerHTML = propsHtml;
                    } else {
                        propsList.textContent = '無';
                    }
                });
            }
            
            updatePropertyOwner(propertyId, playerId) {
                const spaceEl = document.querySelector(`.space[data-id='${propertyId}']`);
                let indicator = spaceEl.querySelector('.property-owned-indicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.className = 'property-owned-indicator';
                    spaceEl.appendChild(indicator);
                }
                indicator.style.backgroundColor = game.players[playerId].tokenColor;
            }

            updatePropertyNickname(propertyId, nickname) {
                const spaceEl = document.querySelector(`.space[data-id='${propertyId}'] .space-name`);
                if (!spaceEl) return;

                let nicknameEl = spaceEl.querySelector('.property-nickname');
                if (!nicknameEl) {
                    nicknameEl = document.createElement('div');
                    nicknameEl.className = 'property-nickname';
                    spaceEl.appendChild(nicknameEl);
                }
                nicknameEl.textContent = `"${nickname}"`;
                this.updatePlayerInfo(); // 更新玩家資訊卡以顯示暱稱
            }

            moveToken(playerId, position) {
                const token = document.getElementById(`token-${playerId}`);
                if (!token) {
                    // console.error(`找不到玩家 ${playerId} 的棋子`);
                    return;
                }
                const targetSpace = document.querySelector(`.space[data-id='${position}']`);
                
                // 在一格內定位棋子以避免重疊
                const offsets = [
                    { top: '25%', left: '25%' }, { top: '25%', right: '25%' },
                    { bottom: '25%', left: '25%' }, { bottom: '25%', right: '25%' },
                    { top: '45%', left: '25%' }, { top: '45%', right: '25%' }
                ];
                const offset = offsets[playerId % offsets.length];
                
                Object.keys(offset).forEach(key => token.style[key] = offset[key]);
                ['top', 'bottom', 'left', 'right'].forEach(prop => {
                    if (!offset[prop]) token.style[prop] = 'auto';
                });

                targetSpace.appendChild(token);
            }

            updateLog(message) {
                this.logMessage.textContent = message;
            }

            updateDice(d1, d2) {
                this.dice1.textContent = d1;
                this.dice2.textContent = d2;
            }
            
            async animateDiceRoll() {
                audio.playSound('dice');
                this.dice1.classList.add('dice-rolling');
                this.dice2.classList.add('dice-rolling');
                await new Promise(resolve => setTimeout(resolve, 500));
                this.dice1.classList.remove('dice-rolling');
                this.dice2.classList.remove('dice-rolling');
            }

            enableRollDice() {
                this.rollDiceBtn.disabled = false;
                this.rollDiceBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                this.rollDiceBtn.classList.remove('hidden');
                this.endTurnBtn.classList.add('hidden');
            }
            
            disableRollDice() {
                this.rollDiceBtn.disabled = true;
                this.rollDiceBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }

            enableEndTurn() {
                this.disableRollDice();
                this.rollDiceBtn.classList.add('hidden');
                this.endTurnBtn.classList.remove('hidden');
            }

            showModal(title, body, actions) {
                this.modalTitle.textContent = title;
                this.modalBody.innerHTML = body;
                this.modalActions.innerHTML = '';
                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.innerHTML = action.label; // 使用 innerHTML 以支援圖示/旋轉動畫
                    button.className = action.className;
                    if (action.id) button.id = action.id;
                    button.onclick = (e) => {
                        // 如果回呼函數返回 false，則不關閉視窗
                        if (action.callback(e.currentTarget) !== false) {
                           this.hideModal();
                        }
                    };
                    this.modalActions.appendChild(button);
                });

                this.modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    this.modalBackdrop.classList.remove('opacity-0');
                    this.modal.classList.remove('scale-95');
                }, 10);
            }

            hideModal() {
                this.modalBackdrop.classList.add('opacity-0');
                this.modal.classList.add('scale-95');
                setTimeout(() => this.modalBackdrop.classList.add('hidden'), 300);
            }
            
            showBuyPropertyDialog(player, property) {
                const title = `出售中: ${property.name}`;
                const body = `
                    <p>此地產無人擁有。</p>
                    <p class="text-2xl font-bold my-4 text-amber-300">價格: $${property.price}</p>
                    <p>您目前的現金: $${player.cash}</p>
                `;
                let actions = [
                    {
                        label: `以 $${property.price} 購買`,
                        className: 'bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded',
                        callback: () => game.buyProperty(player, property)
                    },
                    {
                        label: '放棄 (拍賣)',
                        className: 'bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded',
                        callback: () => {
                            game.log(`${player.name} 放棄購買。地產將進行拍賣。`);
                            game.isTurnOver = true;
                            this.enableEndTurn();
                        }
                    }
                ];
                
                if (player.cash >= property.price) {
                    actions.splice(1, 0, {
                        label: '<span>✨ AI 取個小名</span>',
                        className: 'bg-sky-700 hover:bg-sky-800 text-white font-bold py-2 px-4 rounded flex items-center justify-center space-x-2',
                        callback: (button) => {
                            game.generateNickname(property, button);
                            return false; // 不要關閉視窗
                        }
                    });
                } else {
                    actions.shift(); // 如果無法負擔，則移除購買按鈕
                }

                this.showModal(title, body, actions);
            }

            async showCard(card, type) {
                const title = type === 'chance' ? '機會' : '公益福利';
                const color = type === 'chance' ? 'bg-orange-400' : 'bg-blue-400';
                const body = `
                    <div class="card-flip-container" style="width: 300px; height: 180px;">
                        <div class="card-flipper">
                            <div class="card-face card-front ${type === 'chance' ? 'bg-orange-200' : 'bg-blue-200'}">
                                <span class="text-2xl font-bold text-slate-700">${title}</span>
                            </div>
                            <div class="card-face card-back ${color}">
                                ${card.text}
                            </div>
                        </div>
                    </div>
                `;
                this.showModal(title, body, []);
                
                await new Promise(resolve => setTimeout(resolve, 100));
                const flipper = this.modal.querySelector('.card-flipper');
                flipper.classList.add('flipped');
                
                await new Promise(resolve => setTimeout(resolve, 2500));
                this.hideModal();
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            handlePlayerBankruptcy(playerId) {
                const card = document.getElementById(`player-info-${playerId}`);
                card.classList.add('bankrupt');
                const token = document.getElementById(`token-${playerId}`);
                if(token) token.remove();
            }

            showManagePropertiesDialog() {
                const player = game.getCurrentPlayer();
                let body = '<div class="text-left max-h-96 overflow-y-auto">';
                
                const grouped = {};
                boardData.forEach(p => {
                    if (p.color) {
                        if (!grouped[p.color]) grouped[p.color] = [];
                        grouped[p.color].push(p);
                    }
                });

                for (const color in grouped) {
                    const group = grouped[color];
                    const ownedByPlayer = group.filter(p => player.properties.has(p.id));
                    if (ownedByPlayer.length === 0) continue;

                    const hasMonopoly = ownedByPlayer.length === group.length;
                    
                    body += `<div class="p-2 rounded mb-2" style="border: 2px solid ${color};">`;
                    body += `<h4 class="font-bold text-lg mb-2" style="color: ${color}; text-shadow: 1px 1px #000;">${group[0].name.split(' ')[0]} 地區</h4>`;
                    
                    ownedByPlayer.forEach(prop => {
                        const propState = game.propertyOwners[prop.id];
                        body += `<div class="p-2 bg-slate-700 rounded mb-1">
                                    <p class="font-bold">${prop.name}</p>
                                    <p>房屋: ${propState.houses < 5 ? propState.houses : '旅館'}</p>
                                    <div class="flex space-x-2 mt-2">`;
                        
                        if (hasMonopoly && !propState.mortgaged) {
                            body += `<button class="bg-green-600 text-xs px-2 py-1 rounded" onclick="manage.build(${prop.id})">蓋房 ($${prop.houseCost})</button>`;
                            if (propState.houses > 0) {
                                body += `<button class="bg-yellow-600 text-xs px-2 py-1 rounded" onclick="manage.sellHouse(${prop.id})">賣房 ($${prop.houseCost / 2})</button>`;
                            }
                        }

                        if (propState.houses === 0) {
                             if (propState.mortgaged) {
                                body += `<button class="bg-blue-600 text-xs px-2 py-1 rounded" onclick="manage.unmortgage(${prop.id})">贖回 ($${Math.ceil((prop.price/2) * 1.1)})</button>`;
                            } else {
                                body += `<button class="bg-red-600 text-xs px-2 py-1 rounded" onclick="manage.mortgage(${prop.id})">抵押 ($${prop.price/2})</button>`;
                            }
                        }
                                    
                        body += `   </div>
                                </div>`;
                    });

                    body += `</div>`;
                }

                body += '</div>';

                this.showModal('管理資產', body, [{ label: '關閉', className: 'bg-slate-600 px-4 py-2 rounded', callback: () => {} }]);
            }

            updateHouses(propertyId, houseCount) {
                const container = document.querySelector(`.space[data-id='${propertyId}'] .houses-container`);
                if (!container) return;
                container.innerHTML = '';
                if (houseCount === 5) {
                    container.innerHTML = '<div class="hotel"></div>';
                } else {
                    for (let i = 0; i < houseCount; i++) {
                        container.innerHTML += '<div class="house"></div>';
                    }
                }
            }

            updateMortgageVisual(propertyId, isMortgaged) {
                const spaceEl = document.querySelector(`.space[data-id='${propertyId}']`);
                let overlay = spaceEl.querySelector('.mortgaged-overlay');
                if (isMortgaged) {
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.className = 'mortgaged-overlay';
                        overlay.textContent = 'M';
                        spaceEl.appendChild(overlay);
                    }
                } else {
                    if (overlay) overlay.remove();
                }
            }
            
            flashCash(playerId, isPositive, amount) {
                const cashEl = document.querySelector(`#player-info-${playerId} .cash`);
                if (!cashEl) return;
                
                const changeEl = document.createElement('span');
                changeEl.textContent = `${isPositive ? '+' : '-'}$${amount}`;
                changeEl.className = `absolute -top-6 right-0 font-bold ${isPositive ? 'text-green-400' : 'text-red-400'}`;
                changeEl.style.transition = 'opacity 0.5s, transform 0.5s';
                
                const p = cashEl.parentElement;
                p.style.position = 'relative';
                p.appendChild(changeEl);
                
                setTimeout(() => {
                    changeEl.style.opacity = '0';
                    changeEl.style.transform = 'translateY(-20px)';
                    setTimeout(() => changeEl.remove(), 500);
                }, 1000);
            }

            showOptionsDialog() {
                const body = `
                    <div class="text-left space-y-4">
                        <div>
                            <label for="starting-cash" class="block mb-2">起始資金:</label>
                            <input type="number" id="starting-cash" value="${game.config.startingCash}" class="w-full p-2 rounded bg-slate-600">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="free-parking-jackpot" class="w-4 h-4" ${game.config.freeParkingJackpot ? 'checked' : ''}>
                            <label for="free-parking-jackpot" class="ml-2">啟用停車場獎金規則</label>
                        </div>
                    </div>
                `;
                const actions = [
                    {
                        label: '儲存',
                        className: 'bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded',
                        callback: () => {
                            game.config.startingCash = parseInt(document.getElementById('starting-cash').value) || 1500;
                            game.config.freeParkingJackpot = document.getElementById('free-parking-jackpot').checked;
                            game.saveConfig();
                            game.log("選項已儲存。將在下一場新遊戲生效。");
                        }
                    }
                ];
                this.showModal('遊戲選項', body, actions);
            }
        }
        
        class AudioController {
            constructor() {
                this.isStarted = false;
                this.sounds = {};
            }

            async start() {
                if (this.isStarted) return;
                await Tone.start();
                this.isStarted = true;
                console.log("音訊已準備就緒");
                this.setupSounds();
            }
            
            setupSounds() {
                this.sounds.dice = new Tone.NoiseSynth({
                    noise: { type: 'white' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0 }
                }).toDestination();

                this.sounds.move = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 }
                }).toDestination();

                this.sounds.cash = new Tone.Synth({
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }
                }).toDestination();
                
                this.sounds.buy = new Tone.Synth({
                    oscillator: { type: 'square' },
                    envelope: { attack: 0.01, decay: 0.4, sustain: 0, release: 0.1 }
                }).toDestination();
                
                this.sounds.jail = new Tone.MetalSynth({
                    frequency: 100,
                    envelope: { attack: 0.001, decay: 0.4, release: 0.2 },
                    harmonicity: 5.1,
                    modulationIndex: 32,
                    resonance: 4000,
                    octaves: 1.5
                }).toDestination();

                this.sounds.card = new Tone.Player("https://interactive-examples.mdn.mozilla.net/media/cc0-audio/card-flip.mp3").toDestination();
            }

            playSound(soundName) {
                if (!this.isStarted || !this.sounds[soundName]) return;

                switch(soundName) {
                    case 'dice':
                        this.sounds.dice.triggerAttack();
                        break;
                    case 'move':
                        this.sounds.move.triggerAttackRelease('C5', '8n');
                        break;
                    case 'cash':
                        this.sounds.cash.triggerAttackRelease('E6', '8n', Tone.now());
                        this.sounds.cash.triggerAttackRelease('G6', '8n', Tone.now() + 0.1);
                        break;
                    case 'pay':
                         this.sounds.cash.triggerAttackRelease('G5', '8n', Tone.now());
                        this.sounds.cash.triggerAttackRelease('E5', '8n', Tone.now() + 0.1);
                        break;
                    case 'buy':
                        this.sounds.buy.triggerAttackRelease('C4', '8n');
                        this.sounds.buy.triggerAttackRelease('G4', '8n', Tone.now() + 0.1);
                        this.sounds.buy.triggerAttackRelease('C5', '8n', Tone.now() + 0.2);
                        break;
                    case 'jail':
                        this.sounds.jail.triggerAttackRelease('0.4');
                        break;
                    case 'card':
                        if (this.sounds.card.loaded) {
                            this.sounds.card.start();
                        }
                        break;
                }
            }
        }

        // --- CONTROLLER: 遊戲初始化與資產管理 ---
        const game = new Game();
        const ui = new UI();
        const audio = new AudioController();
        game.loadConfig();
        ui.initialize();

        // 獨立的管理物件，避免在 HTML 中寫複雜的 game.xxx() 呼叫
        const manage = {
            build: (propId) => {
                const player = game.getCurrentPlayer();
                const prop = boardData[propId];
                const propState = game.propertyOwners[propId];
                if (player.cash >= prop.houseCost && propState.houses < 5) {
                    player.pay(prop.houseCost);
                    propState.houses++;
                    game.log(`${player.name} 在 ${prop.name} 蓋了一棟房子。`);
                    ui.updateHouses(propId, propState.houses);
                    ui.showManagePropertiesDialog(); // Refresh modal
                    ui.updatePlayerInfo();
                }
            },
            sellHouse: (propId) => {
                const player = game.getCurrentPlayer();
                const prop = boardData[propId];
                const propState = game.propertyOwners[propId];
                if (propState.houses > 0) {
                    player.updateCash(prop.houseCost / 2);
                    propState.houses--;
                    game.log(`${player.name} 賣掉了 ${prop.name} 的一棟房子。`);
                    ui.updateHouses(propId, propState.houses);
                    ui.showManagePropertiesDialog();
                    ui.updatePlayerInfo();
                }
            },
            mortgage: (propId) => {
                const player = game.getCurrentPlayer();
                const prop = boardData[propId];
                const propState = game.propertyOwners[propId];
                if (!propState.mortgaged) {
                    player.updateCash(prop.price / 2);
                    propState.mortgaged = true;
                    game.log(`${player.name} 抵押了 ${prop.name}。`);
                    ui.updateMortgageVisual(propId, true);
                    ui.showManagePropertiesDialog();
                    ui.updatePlayerInfo();
                }
            },
            unmortgage: (propId) => {
                const player = game.getCurrentPlayer();
                const prop = boardData[propId];
                const propState = game.propertyOwners[propId];
                const cost = Math.ceil((prop.price / 2) * 1.1);
                if (propState.mortgaged && player.cash >= cost) {
                    player.pay(cost);
                    propState.mortgaged = false;
                    game.log(`${player.name} 贖回了 ${prop.name}。`);
                    ui.updateMortgageVisual(propId, false);
                    ui.showManagePropertiesDialog();
                    ui.updatePlayerInfo();
                }
            }
        }

    </script>
</body>
</html>

